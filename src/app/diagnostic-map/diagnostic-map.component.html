<app-header></app-header>

<div class="map-container">
    <div class="controls">
        <p *ngIf="latestObservationTime" class="observation-time">
            Latest Observation: <br> {{ latestObservationTime }}
        </p>
        <label for="variable-select">Select Variable:</label>
        <select id="variable-select" (change)="updateVariable($event)">
            <option *ngFor="let option of variableOptions" [value]="option.id">
                {{ option.name }}
            </option>
        </select>
    </div>

    <div id="map"></div>

    <div *ngIf="selectedStation" class="sidebar">
        <h3>{{ selectedStation.name }} ID #{{ selectedStation.id }}</h3>
        <p *ngIf="selectedStation?.id === '0521'">
            Diagnostic data applies to stations ID #0520 and #0521
        </p>
        <p><strong>Latitude:</strong> {{ selectedStation.lat }}</p>
        <p><strong>Longitude:</strong> {{ selectedStation.lng }}</p>
        <p *ngIf="selectedStation.detailsTimestamp">
            <strong>Latest Measurement:</strong> {{ selectedStation.detailsTimestamp }}
        </p>
        <div class="station-details" *ngIf="selectedStation.details && objectKeys(selectedStation.details).length > 0; else noData">
            <div class="details-header">
                <h4 style="margin-bottom: 0;">Diagnostic Observations</h4>
            </div>
    
            <table class="details-table">
                <thead>
                    <tr>
                        <th>Variable</th>
                        <th>Latest</th>
                        <th>24H Min/Max</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngIf="selectedStation.id === '0521'; else normalStationData">
                        <ng-container *ngFor="let stationId of ['0520', '0521']">
                            <ng-container *ngFor="let key of objectKeys(selectedStation.details[stationId])">
                                <tr *ngIf="key.startsWith('Current ')">
                                    <td>{{ stationId }} {{ getVariableName(key.replace('Current ', '')) }}</td>
                                    <td>{{ selectedStation.details[stationId][key] }}</td>
                                    <td>
                                        <span *ngIf="selectedStation.details[stationId]['24H Min ' + key.replace('Current ', '')]">
                                            Min: {{ selectedStation.details[stationId]['24H Min ' + key.replace('Current ', '')] }}
                                        </span>
                                        <span *ngIf="selectedStation.details[stationId]['24H Max ' + key.replace('Current ', '')]">
                                            Max: {{ selectedStation.details[stationId]['24H Max ' + key.replace('Current ', '')] }}
                                        </span>
                                    </td>
                                    <td [ngClass]="getStatusClass(
                                            getVariableName(key.replace('Current ', '')),
                                            selectedStation.details[stationId]['24H Min ' + key.replace('Current ', '')] || 
                                            selectedStation.details[stationId]['24H Max ' + key.replace('Current ', '')]
                                        )">
                                        {{ getStatus(
                                            getVariableName(key.replace('Current ', '')),
                                            selectedStation.details[stationId]['24H Min ' + key.replace('Current ', '')] || 
                                            selectedStation.details[stationId]['24H Max ' + key.replace('Current ', '')]
                                        ) }}
                                    </td>
                                </tr>
                            </ng-container>
                        </ng-container>
                    </ng-container>

                    <ng-template #normalStationData>
                        <ng-container *ngFor="let key of objectKeys(selectedStation.details)">
                            <tr *ngIf="key.startsWith('Current ')">
                                <td>{{ getVariableName(key.replace('Current ', '')) }}</td>
                                <td>{{ selectedStation.details[key] }}</td>
                                <td>
                                    <span *ngIf="selectedStation.details['24H Min ' + key.replace('Current ', '')]">
                                        Min: {{ selectedStation.details['24H Min ' + key.replace('Current ', '')] }}
                                    </span>
                                    <span *ngIf="selectedStation.details['24H Max ' + key.replace('Current ', '')]">
                                        Max: {{ selectedStation.details['24H Max ' + key.replace('Current ', '')] }}
                                    </span>
                                </td>
                                <td [ngClass]="getStatusClass(
                                        getVariableName(key.replace('Current ', '')),
                                        selectedStation.details['24H Min ' + key.replace('Current ', '')] || 
                                        selectedStation.details['24H Max ' + key.replace('Current ', '')]
                                    )">
                                    {{ getStatus(
                                        getVariableName(key.replace('Current ', '')),
                                        selectedStation.details['24H Min ' + key.replace('Current ', '')] || 
                                        selectedStation.details['24H Max ' + key.replace('Current ', '')]
                                    ) }}
                                </td>
                            </tr>
                        </ng-container>
                    </ng-template>
                </tbody>


            </table>


            <!-- Sensor Latest Update Section -->
            <div *ngIf="hasSensorUpdateVariables()" class="details-header">
                <h4 style="margin-bottom: 0;">Sensor Latest Update</h4>
            </div>
            <ul *ngIf="hasSensorUpdateVariables()" class="sensor-update-list">
                <ng-container *ngFor="let key of sensorUpdateVars">
                    <li *ngIf="selectedStation.details[key]">
                        <strong>{{ getVariableName(key) }}:</strong> {{ selectedStation.details[key] }}
                    </li>
                </ng-container>
            </ul>

        </div>

        <!-- Show a message if no recent data is available -->
        <ng-template #noData>
            <p *ngIf="selectedStation.details && objectKeys(selectedStation.details).length === 0">No recent data available.</p>
            <p *ngIf="!selectedStation.details">Loading data...</p> 
        </ng-template>


        <!-- Show a message if no recent data is available -->
        <ng-template #noData>
            <p *ngIf="selectedStation.details && objectKeys(selectedStation.details).length === 0">No recent data available.</p>
            <p *ngIf="!selectedStation.details">Loading data...</p> 
        </ng-template>


        <ng-template #loadingData>
            <p *ngIf="selectedStation.details && objectKeys(selectedStation.details).length === 0">No recent data available.</p>
            <p *ngIf="!selectedStation.details">Loading data...</p> 
        </ng-template>

        <div class="sidebar-buttons">
            <a [href]="selectedStation.url" target="_blank" class="button">Open Dashboard</a>
            <button class="close-btn" (click)="closeSidebar()">Close</button>
        </div>
    </div>


</div>